<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TerraScope — Satellite Data On Demand</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet (Map) CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <!-- Flatpickr (Calendar) CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <style>

    /* Scale-style accent: animated conic gradient, light stroke, soft glow */
    .hero-accent{
      background: conic-gradient(from 210deg at 50% 50%,
                  #a78bfa, #60a5fa, #22d3ee, #f472b6, #a78bfa);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;

      /* subtle definition so it doesn’t look “flat” */
      -webkit-text-stroke: 0.6px rgba(255,255,255,.22);
      text-shadow:
        0 0 24px rgba(147,112,219,.35),
        0 0 48px rgba(34,211,238,.18);

      animation: heroHue 12s ease-in-out infinite alternate;
    }
    @keyframes heroHue{
      0%{ background-position: 0% 50%; }
      100%{ background-position: 100% 50%; }
    }
    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .hero-accent{ animation: none; }
    }

    /* Map containers */
    #leafletMapSheet { height:100%; min-height:320px; }
    .leaflet-container { background: #0a0a0a; }

    /* —— Hero —— */
    .hero{position:relative;min-height:110vh;overflow:hidden;background:#000}
    .hero .imgwrap{position:absolute;inset:0;overflow:hidden;z-index:0}
    .hero img{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      object-position:50% 105%;
      transform-origin:center;
      animation:kenburns 48s ease-in-out infinite alternate;
      filter:saturate(1.05) contrast(1.05) brightness(.95);
    }
    @keyframes kenburns{0%{transform:scale(1.06) translateY(0%)}100%{transform:scale(1.09) translateY(-1.2%)}}

    #message { resize: vertical; }

    .cinema{position:absolute;inset:-8%;pointer-events:none;mix-blend-mode:screen;opacity:.35;filter:blur(10px);z-index:1}
    .cinema::before,.cinema::after{content:"";position:absolute;inset:0}
    .cinema::before{
      background:
        radial-gradient(90% 70% at 20% 10%, rgba(160,220,255,.18), transparent 60%),
        radial-gradient(100% 80% at 85% 35%, rgba(200,160,255,.16), transparent 60%);
      animation:driftA 60s ease-in-out infinite;
    }
    .cinema::after{
      background:conic-gradient(from 0deg at 60% 15%, rgba(120,200,255,.10),
                 transparent 35%, rgba(200,160,255,.10) 65%, transparent 85%);
      transform-origin:60% 15%;
      animation:driftB 90s linear infinite;opacity:.45;
    }
    @keyframes driftA{0%{transform:translate3d(-1%,0,0) scale(1.02)}50%{transform:translate3d(1%,-1%,0) scale(1.03)}100%{transform:translate3d(-1%,0,0) scale(1.02)}}
    @keyframes driftB{to{transform:rotate(360deg) scale(1.02)}}

    .topfade{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.90),rgba(0,0,0,.45) 35%,rgba(0,0,0,0) 70%);z-index:2}
    .botfade{position:absolute;left:0;right:0;bottom:0;height:22vh;background:linear-gradient(to bottom,rgba(0,0,0,0),rgba(0,0,0,1));z-index:2}

    .grain{position:absolute;inset:0;pointer-events:none;opacity:.05;mix-blend-mode:soft-light;z-index:1;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.10) 0 1px, transparent 1px 2px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.10) 0 1px, transparent 1px 2px);
      animation:grainShift 6s steps(2) infinite}
    @keyframes grainShift{50%{transform:translate3d(.6px,.6px,0)}}

    /* Glass card + subtle reflection */
    .glass-card{
      position: relative; overflow: hidden;
      backdrop-filter: blur(16px);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 1rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .glass-card.reflection::before{
      content:""; position:absolute; top:-35%; left:-20%;
      width:140%; height:60%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.22), rgba(255,255,255,0));
      transform: rotate(-6deg); pointer-events:none;
    }

    #processingCard { background: transparent; }

    .icon{ opacity: 0; transform: scale(.96); animation: iconCycle 8s linear infinite; }
    .icon--discovery  { animation-delay: 0s; }
    .icon--subsetting { animation-delay: 2s; }
    .icon--reproject  { animation-delay: 4s; }
    .icon--export     { animation-delay: 6s; }
    @keyframes iconCycle{ 0% { opacity: 0; transform: scale(.96); } 5% { opacity: 1; transform: scale(1); } 20% { opacity: 1; transform: scale(1); } 25% { opacity: 0; transform: scale(1.04); } 100% { opacity: 0; transform: scale(1.04); } }
    @keyframes ants   { to { stroke-dashoffset: -12 } }
    @keyframes orbit  { to { transform: rotate(360deg); } }

    .urg { --pill-bg: rgba(255,255,255,.06); --pill-border: rgba(255,255,255,.18); --hover-bg: rgba(255,255,255,.14); }
    .urg-asap     { --pill-bg: rgba(255,159,67,.18);  --pill-border: rgba(255,159,67,.42);  --hover-bg: rgba(255,159,67,.22); }
    .urg-standard { --pill-bg: rgba(34,197,94,.18);   --pill-border: rgba(34,197,94,.42);   --hover-bg: rgba(34,197,94,.22); }
    .urg-norush   { --pill-bg: rgba(59,130,246,.18);  --pill-border: rgba(59,130,246,.42);  --hover-bg: rgba(59,130,246,.22); }
    .urg-btn{ background: var(--pill-bg); border: 1px solid var(--pill-border); color: #fff; backdrop-filter: blur(10px); }
    .urg-menu{ background: rgba(255,255,255,.08); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,.12); border-radius: .75rem; }
    .urg-opt { color: #fff; }
    .urg-opt.asap:hover     { background: rgba(255,159,67,.22); }
    .urg-opt.standard:hover { background: rgba(34,197,94,.22);  }
    .urg-opt.norush:hover   { background: rgba(59,130,246,.22); }
    .urg-open .urg-caret{ transform: rotate(180deg); }

    /* --- FIX: Prevent hero animation ONLY when map modal is open --- */
    .body--modal-open .hero img,
    .body--modal-open .cinema::before,
    .body--modal-open .cinema::after,
    .body--modal-open .grain {
      animation: none !important;
      transform: none !important;
    }
    
    body.modal-open { overflow: hidden; }
    .leaflet-control-container { z-index: 50 !important; }

    /* Custom Flatpickr Glassy Theme */
    .flatpickr-calendar { backdrop-filter: blur(16px); background: rgba(20, 20, 20, 0.75); border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0,0,0,0.35); color: #e5e7eb; }
    .flatpickr-months .flatpickr-month, .flatpickr-current-month .flatpickr-monthDropdown-months { color: #fff; fill: #fff; }
    .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { fill: #9ca3af; }
    .flatpickr-months .flatpickr-prev-month:hover svg, .flatpickr-months .flatpickr-next-month:hover svg { fill: #22d3ee; }
    span.flatpickr-weekday { color: #9ca3af; }
    .flatpickr-day { color: #d1d5db; }
    .flatpickr-day:hover, .flatpickr-day:focus { background: rgba(34,197,94, 0.22); border-color: transparent; }
    .flatpickr-day.today { border-color: #22d3ee; }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background: #3b82f6; border-color: #3b82f6; color: #fff; }
    .flatpickr-day.inRange { background: rgba(59, 130, 246, 0.25); border-color: transparent; box-shadow: -5px 0 0 rgba(59, 130, 246, 0.25), 5px 0 0 rgba(59, 130, 246, 0.25); }
    .numInput, .numInputWrapper, .flatpickr-current-month input.cur-year { color: #fff; }
    .numInput:hover, .flatpickr-current-month input.cur-year:hover { background: rgba(255,255,255,0.1); }
    .flatpickr-day.disabled, .flatpickr-day.disabled:hover { color: rgba(255,255,255,0.2); }

    /* Urgency helper visibility */
    .urg-help { display: none; }
    .urg-help.show { display: block; }
  </style>
</head>
<body class="bg-black text-white">

  <!-- NAVBAR (non-fixed) -->
  <header class="relative w-full bg-transparent">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="#hero" class="flex items-center gap-3">
        <img src="./earthlabs.png" alt="TerraScope logo" class="h-8 md:h-9 w-auto object-contain" />
      </a>
      <nav class="space-x-8 text-sm">
        <a href="#about" class="hover:text-cyan-400 transition">About</a>
        <a href="#request" class="hover:text-cyan-400 transition">Request Data</a>
      </nav>
    </div>
    <div class="absolute inset-0 pointer-events-none bg-gradient-to-b from-black/50 to-transparent"></div>
  </header>

  <!-- HERO -->
  <section class="hero" id="hero">
    <div class="imgwrap">
      <img src="Gemini_Generated_Image_epc5w4epc5w4epc5.jpg" alt="Earth from space"/>
    </div>
    <div class="topfade"></div>
    <div class="cinema"></div>
    <div class="grain"></div>
    <div class="botfade"></div>
    <div class="absolute inset-x-0 top-0 z-20" style="height: 400px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0));"></div>

    <div class="relative z-30 max-w-5xl mx-auto px-6 pt-20 md:pt-20 text-center">
      <h1 class="hero-title text-5xl md:text-7xl font-thin tracking-tight leading-tight text-white">
        Processed <span class="hero-accent">Satellite Data</span> - Delivered
      </h1>
      <p class="mt-8 text-2xl md:text-xl font-normal text-gray-100 max-w-4xl mx-auto">
        From plain language requests to Oceanographic Datasets — ready to use in your inbox.
      </p>

      <!-- FUSED REQUEST FORM -->
       <main class="max-w-6xl mx-auto px-6 pb-16">
    <!-- TWO CARDS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- LEFT: FORM CARD -->
      <div class="rounded-[28px] bg-white/5 border border-white/20 p-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input id="name"  placeholder="Name"
                 class="min-w-0 w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20" />
          <input id="email" placeholder="Email"
                 class="min-w-0 w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20" />

          <textarea id="description" placeholder="Describe the data you need"
            class="sm:col-span-2 min-h-[140px] rounded-xl px-3 py-2 bg-black/30 border border-white/20"></textarea>

          <input id="start_date" placeholder="Start Date"
                 class="min-w-0 w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20" />
          <input id="end_date"   placeholder="End Date"
                 class="min-w-0 w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20" />
        </div>

        <!-- Urgency + Submit/Clear -->
        <div class="mt-3 flex items-center gap-3">
          <input id="urgency" placeholder="Urgency"
                 class="min-w-0 w-full sm:w-auto flex-1 rounded-xl px-3 py-2 bg-black/30 border border-white/20" />
          <div class="ml-auto flex items-center gap-3">
            <button id="submitBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Submit</button>
            <button id="clearBtn"  class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Clear</button>
          </div>
        </div>

        <!-- Hidden fields + preview line -->
        <input id="area_bbox" type="hidden">
        <input id="area_bbox_cardinal" type="hidden">
        <p id="areaPreview" class="mt-3 text-sm text-white/80 hidden">
          <span class="text-white/60">Selected area:</span> <span id="previewLabel"></span>
        </p>
      </div>

      <!-- RIGHT: MAP CARD -->
      <div class="rounded-[28px] bg-white/5 border border-white/20 p-5">
        <!-- NORTH on top -->
        <div class="flex justify-center mb-3">
          <input id="coordLatN" type="number" step="0.0001" min="-90" max="90"
            placeholder="North"
            class="w-[180px] rounded-xl px-3 py-2 bg-black/30 border border-white/20 text-center" />
        </div>

        <!-- Square map -->
        <div class="relative">
          <div id="coordsMap"
               class="w-full aspect-square rounded-[24px] border border-white/15 overflow-hidden"></div>
        </div>

        <!-- WEST / SOUTH / EAST -->
        <div class="mt-3 grid grid-cols-3 gap-3">
          <input id="coordLonW" type="number" step="0.0001" min="-180" max="180"
            placeholder="West"
            class="w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20 text-center" />
          <input id="coordLatS" type="number" step="0.0001" min="-90" max="90"
            placeholder="South"
            class="w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20 text-center" />
          <input id="coordLonE" type="number" step="0.0001" min="-180" max="180"
            placeholder="East"
            class="w-full rounded-xl px-3 py-2 bg-black/30 border border-white/20 text-center" />
        </div>

        <!-- Actions -->
        <div class="mt-3 flex justify-end gap-3">
          <button id="useCoordsBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">
            Use these coordinates
          </button>
          <button id="openAreaPicker" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">
            Select Area on Map
          </button>
        </div>
      </div>

    </div>
  </main>

        <!-- PROCESSING CARD -->
        <div id="processingCard" class="hidden glass-card reflection p-8 mt-6 text-center min-h-[18rem]">
            <!-- content unchanged -->
        </div>
      </div>
    </div>
  </section>

  <!-- LOGO STRIP -->
  <section class="bg-black py-8">
    <p class="text-center text-gray-400 text-xs md:text-sm tracking-wider mb-5">Data Sources & Technology We Use</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 md:gap-8 w-full">
      <div class="flex items-center justify-center h-16 md:h-20"><img src="./logos/google.png" alt="Google" class="max-h-12 md:max-h-14 w-auto object-contain opacity-90" loading="lazy"></div>
      <div class="flex items-center justify-center h-16 md:h-20"><img src="./logos/copernicus.png" alt="Copernicus" class="max-h-12 md:max-h-14 w-auto object-contain opacity-90" loading="lazy"></div>
      <div class="flex items-center justify-center h-16 md:h-20"><img src="./logos/esa.png" alt="ESA" class="max-h-12 md:max-h-14 w-auto object-contain opacity-90" loading="lazy"></div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="py-20 bg-black">
    <div class="max-w-5xl mx-auto px-6 text-center">
      <h3 class="text-3xl font-semibold text-cyan-400">How It Works</h3>
      <p class="mt-4 text-gray-400 max-w-2xl mx-auto">We translate plain-language requests into precise data pulls, process them, and deliver clean outputs (CSV, GeoTIFF, plots).</p>
      <div class="mt-12 grid gap-6 md:grid-cols-3">
        <!-- 1. Describe -->
        <div class="bg-white/5 p-6 rounded-xl text-left">
          <img src="./icons/terra1.png" alt="Globe Icon" class="block mx-auto w-20 h-20 mb-4 opacity-80">
          <h4 class="text-center font-semibold text-cyan-300 mb-1">1. Describe</h4>
          <p class="text-gray-400 text-sm">Tell us what variable, where, and when.</p>
          <ul class="mt-3 text-gray-300 text-sm list-disc list-inside space-y-1">
            <li><span class="font-medium">What:</span> variables/products (e.g., SST, chlorophyll, altimetry), units.</li>
            <li><span class="font-medium">Where:</span> draw on the map or give coords/CRS (optional).</li>
            <li><span class="font-medium">When:</span> start–end dates or event window.</li>
            <li><span class="font-medium">Cadence:</span> hourly, daily, weekly, monthly.</li>
            <li><span class="font-medium">Format:</span> CSV, GeoTIFF, shapefile; any size/cloud limits.</li>
          </ul>
        </div>

        <!-- 2. Prepare -->
        <div class="bg-white/5 p-6 rounded-xl text-left">
          <img src="./icons/terra2.png" alt="Globe Icon" class="block mx-auto w-20 h-20 mb-4 opacity-80">
          <h4 class="text-center font-semibold text-cyan-300 mb-1">2. Prepare</h4>
          <p class="text-gray-400 text-sm">We source, subset, reproject, and format.</p>
          <ul class="mt-3 text-gray-300 text-sm list-disc list-inside space-y-1">
            <li><span class="font-medium">Source & check:</span> best-fit datasets; coverage & quality.</li>
            <li><span class="font-medium">Clean:</span> QC flags, cloud/land/ice masks, de-striping where needed.</li>
            <li><span class="font-medium">Subset & transform:</span> area crop, reprojection, resampling.</li>
            <li><span class="font-medium">Aggregate:</span> stats over time (mean, max, anomalies), mosaics/merges.</li>
            <li><span class="font-medium">Visualize:</span> quick-look maps/plots for sanity checks.</li>
          </ul>
        </div>

        <!-- 3. Deliver -->
        <div class="bg-white/5 p-6 rounded-xl text-left">
          <img src="./icons/terra3.png" alt="Globe Icon" class="block mx-auto w-20 h-20 mb-4 opacity-80">
          <h4 class="text-center font-semibold text-cyan-300 mb-1">3. Deliver</h4>
          <p class="text-gray-400 text-sm">Receive clean files + a short data brief.</p>
          <ul class="mt-3 text-gray-300 text-sm list-disc list-inside space-y-1">
            <li><span class="font-medium">Outputs:</span> CSV/GeoTIFF (+ figures/maps if requested).</li>
            <li><span class="font-medium">Metadata:</span> provenance, CRS, units, processing steps.</li>
            <li><span class="font-medium">Notes:</span> caveats, QC notes, and how to reproduce.</li>
            <li><span class="font-medium">Handover:</span> link by email; optional shared drive.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="bg-white/5 py-6 text-center text-gray-500 text-sm">
    © 2025 TerraScope. All rights reserved.
  </footer>

<!-- MAP MODAL -->
<div id="mapModal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
  <div id="mapModalBackdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="relative flex flex-col w-[90vw] h-[85vh] max-w-6xl max-h-[800px]
              rounded-2xl border border-white/20 bg-black/50 backdrop-blur-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-white/10 flex-shrink-0">
      <h4 class="text-base font-semibold">Pick Area (draw a rectangle)</h4>
      <button id="closeModalBtn" type="button" class="px-3 py-1 text-sm bg-white/10 hover:bg-white/20 rounded">Close</button>
    </div>
    <div class="flex-grow relative">
      <div id="leafletMapSheet" class="absolute inset-0 w-full h-full"></div>
    </div>
    <div class="flex items-center justify-between gap-4 px-4 py-3 border-t border-white/10 flex-shrink-0">
      <div id="bboxLabel" class="text-xs text-gray-300 truncate">No selection yet.</div>
      <div class="flex gap-2">
        <button id="resetBbox" type="button" class="px-3 py-2 text-sm bg-white/10 hover:bg-white/20 rounded">Reset</button>
        <button id="useBbox" type="button" class="px-4 py-2 text-sm rounded-lg font-semibold bg-gradient-to-r from-cyan-400 to-blue-500 hover:opacity-90">
          Use this Area
        </button>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS BEGIN HERE! -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- JS: Form, Map, and other Logic -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  // ===== FORM SUBMISSION & URGENCY DROPDOWN =====
  const form = document.querySelector('form#request');
  if (!form) return;
  const btnEl = document.getElementById('submitBtn');
  const clearBtn = document.getElementById('clearBtn');
  const processing = document.getElementById('processingCard');
  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');
  const msgEl = document.getElementById('message');
  const subjEl = document.getElementById('subject');
  const statusEl = document.getElementById('statusText') || (() => { const p = document.createElement('p'); p.id = 'statusText'; p.className = 'text-sm text-red-300 mt-1'; form.appendChild(p); return p; })();
  const urgWrap = document.getElementById('urgencySelect');
  const urgBtn = urgWrap ? urgWrap.querySelector('.urg-btn') : null;
  let urgMenu = document.getElementById('urgMenu') || (urgWrap ? urgWrap.querySelector('.urg-menu') : null);
  const urgLabel = urgWrap ? urgWrap.querySelector('.urg-label') : null;
  const urgHidden = document.getElementById('urgVal');
  function setUrgency(val) {
    if (urgLabel) urgLabel.textContent = val;
    if (urgHidden) urgHidden.value = val;
    if (!urgWrap) return;
    urgWrap.classList.remove('urg-asap', 'urg-standard', 'urg-norush');
    if (val.startsWith('ASAP')) urgWrap.classList.add('urg-asap');
    else if (val.startsWith('No rush')) urgWrap.classList.add('urg-norush');
    else urgWrap.classList.add('urg-standard');
  }
  function ensurePortaled() { if (!urgMenu || urgMenu.dataset.portaled) return; document.body.appendChild(urgMenu); urgMenu.dataset.portaled = '1'; urgMenu.style.position = 'fixed'; urgMenu.style.zIndex = '2147483647'; urgMenu.style.margin = '0'; }
  function updateMenuPosition() { if (!urgBtn || !urgMenu) return; const r = urgBtn.getBoundingClientRect(); urgMenu.style.left = Math.round(r.left) + 'px'; urgMenu.style.top = Math.round(r.bottom + 8) + 'px'; urgMenu.style.minWidth = Math.max(r.width, 224) + 'px'; }
  function openMenu() { ensurePortaled(); updateMenuPosition(); urgMenu.classList.remove('hidden'); urgWrap && urgWrap.classList.add('urg-open'); }
  function closeMenu() { if (!urgMenu) return; urgMenu.classList.add('hidden'); urgWrap && urgWrap.classList.remove('urg-open'); }
  if (urgBtn && urgMenu) {
    urgBtn.addEventListener('click', (e) => { e.stopPropagation(); if (urgMenu.classList.contains('hidden')) openMenu(); else closeMenu(); });
    document.addEventListener('click', (e) => { if (!urgWrap.contains(e.target) && !urgMenu.contains(e.target)) closeMenu(); });
    window.addEventListener('scroll', () => { if (!urgMenu.classList.contains('hidden')) updateMenuPosition(); }, { passive: true });
    window.addEventListener('resize', () => { if (!urgMenu.classList.contains('hidden')) updateMenuPosition(); });
    urgMenu.querySelectorAll('.urg-opt, .urg-item').forEach(li => { li.addEventListener('click', () => { setUrgency(li.getAttribute('data-value')); closeMenu(); }); });
    setUrgency(urgHidden?.value || 'Standard (2–3 days)');
  }
  if (clearBtn) { clearBtn.addEventListener('click', () => { form.reset(); setUrgency('Standard (2–3 days)'); statusEl.textContent = ''; statusEl.classList.add('hidden'); }); }
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusEl.classList.add('hidden');
    if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'Sending…'; }
    const who = (nameEl?.value || 'New request').trim();
    const urg = (urgHidden?.value || '').trim();
    if (subjEl) subjEl.value = `TerraScope request — ${who} (${urg})`;
    try {
      const res = await fetch(form.action, { method: 'POST', headers: { 'Accept': 'application/json' }, body: new FormData(form) });
      if (!res.ok) { const data = await res.json().catch(() => ({})); throw new Error(data?.error || 'Failed to submit. Please try again.'); }
      form.classList.add('hidden');
      processing.classList.remove('hidden');
    } catch (err) {
      statusEl.textContent = err.message || 'Network error. Please try again.';
      statusEl.classList.remove('hidden');
    } finally {
      if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'Submit Request'; }
    }
  });

  // ===== Urgency helper toggle =====
  const urgHelpToggle = document.getElementById('urgHelpToggle');
  const urgHelp = document.getElementById('urgHelp');
  urgHelpToggle?.addEventListener('click', () => {
    urgHelp?.classList.toggle('show');
  });

  // ===== DATE PICKER (FLATPICKR) LOGIC =====
// ===== DATE PICKER (FLATPICKR) LOGIC =====
  const startDateEl = document.getElementById("start_date");
  const endDateEl   = document.getElementById("end_date");
  if (startDateEl && endDateEl) {
    const fpStart = flatpickr(startDateEl, {
      altInput: true,
      altInputClass:
        'flatpickr-alt w-full max-w-xs sm:max-w-none mx-auto rounded-xl px-3 py-2 ' +
        'bg-white/5 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400 placeholder-gray-300',
      altFormat: 'M j, Y',
      dateFormat: 'Y-m-d',
      onChange(selectedDates){ fpEnd.set('minDate', selectedDates[0]); }
    });
    const fpEnd = flatpickr(endDateEl, {
      altInput: true,
      altInputClass:
        'flatpickr-alt w-full max-w-xs sm:max-w-none mx-auto rounded-xl px-3 py-2 ' +
        'bg-white/5 border border-white/20 focus:outline-none focus:ring-2 focus:ring-cyan-400 placeholder-gray-300',
      altFormat: 'M j, Y',
      dateFormat: 'Y-m-d'
    });
  }
  

  // ===== AREA PICKER (MODAL LOGIC) =====
  const openPickerBtn = document.getElementById("openAreaPicker");
  const useBboxBtn = document.getElementById("useBbox");
  const resetBboxBtn = document.getElementById("resetBbox");
  const bboxLabel = document.getElementById("bboxLabel");
  const previewWrap = document.getElementById("areaPreview");
  const previewLabel = document.getElementById("bboxLabelInline");
  const editAreaBtn = document.getElementById("editAreaBtn");
  const areaHidden = document.getElementById("area_bbox");
  const areaHiddenCard = document.getElementById("area_bbox_cardinal");
  const mapModal = document.getElementById("mapModal");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const mapModalBackdrop = document.getElementById("mapModalBackdrop");
  let map, drawn, drawControl, currentRect = null, bbox = null;
  const round = n => Math.round(n * 10000) / 10000;
  const fmtLat = lat => `${Math.abs(lat).toFixed(4)}°${lat >= 0 ? 'N' : 'S'}`;
  const fmtLon = lon => `${Math.abs(lon).toFixed(4)}°${lon >= 0 ? 'E' : 'W'}`;
  function openMapModal() {
    document.body.classList.add("modal-open", "body--modal-open");
    mapModal.classList.remove("hidden");
    initMapIfNeeded();
    setTimeout(() => { if (map) { map.invalidateSize(true); if (currentRect) { map.fitBounds(currentRect.getBounds(), { padding: [20, 20] }); } } }, 50);
  }
  function closeMapModal() { mapModal.classList.add("hidden"); document.body.classList.remove("modal-open", "body--modal-open"); }
  function initMapIfNeeded() {
    if (map) return;
    map = L.map("leafletMapSheet", { zoomControl: true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap", maxZoom: 19 }).addTo(map);
    map.setView([20, 0], 2);
    drawn = new L.FeatureGroup(); map.addLayer(drawn);
    drawControl = new L.Control.Draw({ draw: { polygon: false, polyline: false, circle: false, circlemarker: false, marker: false, rectangle: { shapeOptions: { color: "#22d3ee", weight: 2, opacity: 0.9, fillOpacity: 0.1 } } }, edit: { featureGroup: drawn, edit: true, remove: true } });
    map.addControl(drawControl);
    map.on(L.Draw.Event.CREATED, (e) => { if (currentRect) drawn.removeLayer(currentRect); currentRect = e.layer; drawn.addLayer(currentRect); updateBboxLabel(); try { const handler = drawControl?._toolbars?.draw?._modes?.rectangle?.handler; if (handler && handler.disable) handler.disable(); } catch (_) { } });
    map.on("draw:edited", updateBboxLabel);
    map.on("draw:deleted", () => { currentRect = null; bbox = null; bboxLabel.textContent = "No selection yet."; });
  }
  function updateBboxLabel() {
    if (!currentRect) return;
    const b = currentRect.getBounds(); const sw = b.getSouthWest(), ne = b.getNorthEast();
    bbox = { lonW: round(sw.lng), latS: round(sw.lat), lonE: round(ne.lng), latN: round(ne.lat) };
    const numeric = `${bbox.lonW},${bbox.latS} to ${bbox.lonE},${bbox.latN}`;
    const cardinal = `${fmtLon(bbox.lonW)}, ${fmtLat(bbox.latS)} to ${fmtLon(bbox.lonE)}, ${fmtLat(bbox.latN)}`;
    bboxLabel.textContent = cardinal; areaHidden.value = numeric; areaHiddenCard.value = cardinal;
    if (!previewWrap.classList.contains("hidden")) { previewLabel.textContent = cardinal; }
    prefillCoords?.(bbox);
    if (coordsMap) drawOnCoordsMap(bbox);
  }
  resetBboxBtn?.addEventListener("click", () => { if (drawn) drawn.clearLayers(); currentRect = null; bbox = null; bboxLabel.textContent = "No selection yet."; areaHidden.value = areaHiddenCard.value = ""; previewWrap.classList.add("hidden"); openPickerBtn.textContent = "Select Area on Map"; });
  function showPreview(b) { if (!b) return; previewWrap.classList.remove("hidden"); const cardinal = `${fmtLon(b.lonW)}, ${fmtLat(b.latS)} to ${fmtLon(b.lonE)}, ${fmtLat(b.latN)}`; previewLabel.textContent = cardinal; openPickerBtn.textContent = "Change Selected Area"; }
  useBboxBtn?.addEventListener("click", () => { if (!bbox) { bboxLabel.textContent = "Draw a rectangle first."; return; } closeMapModal(); showPreview(bbox); });
  openPickerBtn?.addEventListener("click", openMapModal);
  editAreaBtn?.addEventListener("click", openMapModal);
  closeModalBtn?.addEventListener("click", closeMapModal);
  mapModalBackdrop?.addEventListener("click", closeMapModal);
});

// ===== Manual coordinates + MapLibre inline map =====
const openCoordsForm  = document.getElementById("openCoordsForm");
const coordsForm      = document.getElementById("coordsForm");
const coordLonW       = document.getElementById("coordLonW");
const coordLonE       = document.getElementById("coordLonE");
const coordLatS       = document.getElementById("coordLatS");
const coordLatN       = document.getElementById("coordLatN");
const useCoordsBtn    = document.getElementById("useCoordsBtn");
const cancelCoordsBtn = document.getElementById("cancelCoordsBtn");

let mlMap, mlBounds, mlHasLayer = false;

// Fill inputs from bbox object
function prefillCoords(b) {
  if (!b) return;
  if (coordLonW) coordLonW.value = b.lonW;
  if (coordLonE) coordLonE.value = b.lonE;
  if (coordLatS) coordLatS.value = b.latS;
  if (coordLatN) coordLatN.value = b.latN;
}

function initCoordsMapIfNeeded() {
  if (mlMap || !document.getElementById("coordsMap")) return;

  mlMap = new maplibregl.Map({
    container: "coordsMap",
    style: "https://demotiles.maplibre.org/style.json",
    center: [0, 20],
    zoom: 1.5,
    attributionControl: false,
  });
  mlMap.addControl(new maplibregl.NavigationControl({ showCompass: false }), "top-left");

  mlMap.on("load", () => {
    // recolor land/water
    const waterBlue = "#0ea5e9";
    try { mlMap.setPaintProperty("background", "background-color", waterBlue); } catch {}
    const layers = mlMap.getStyle().layers || [];
    layers.forEach(l => {
      if (l.type === "fill") {
        if ((l.id || "").includes("water")) {
          mlMap.setPaintProperty(l.id, "fill-color", waterBlue);
        } else {
          mlMap.setPaintProperty(l.id, "fill-color", "#ffffff");
        }
      }
    });

    // add bbox source + layers
    mlMap.addSource("bbox", { type: "geojson", data: { type: "FeatureCollection", features: [] }});
    mlMap.addLayer({ id: "bbox-fill", type: "fill", source: "bbox",
                     paint: { "fill-color": "#22d3ee", "fill-opacity": 0.12 }});
    mlMap.addLayer({ id: "bbox-line", type: "line", source: "bbox",
                     paint: { "line-color": "#22d3ee", "line-width": 2 }});
    mlHasLayer = true;

    if (bbox) drawOnCoordsMap(bbox, true);
  });

  // auto-resize with panel
  const formEl = document.getElementById("coordsForm");
  if (formEl) new ResizeObserver(() => queueCoordsMapRefresh()).observe(formEl);
}

function drawOnCoordsMap(b, fitNow = false) {
  if (!mlMap || !mlHasLayer) return;
  const poly = {
    type: "Feature",
    geometry: {
      type: "Polygon",
      coordinates: [[
        [b.lonW, b.latS],
        [b.lonE, b.latS],
        [b.lonE, b.latN],
        [b.lonW, b.latN],
        [b.lonW, b.latS],
      ]]
    },
    properties: {}
  };
  mlMap.getSource("bbox").setData({ type: "FeatureCollection", features: [poly] });
  mlBounds = new maplibregl.LngLatBounds([b.lonW, b.latS], [b.lonE, b.latN]);
  if (fitNow) mlMap.fitBounds(mlBounds, { padding: 14, animate: false });
}

function queueCoordsMapRefresh() {
  if (!mlMap) return;
  requestAnimationFrame(() => {
    mlMap.resize();
    if (mlBounds) mlMap.fitBounds(mlBounds, { padding: 14, animate: false });
  });
}

// Handle open/close
openCoordsForm?.addEventListener("click", () => {
  coordsForm?.classList.toggle("hidden");
  if (!coordsForm?.classList.contains("hidden")) {
    initCoordsMapIfNeeded();
    setTimeout(queueCoordsMapRefresh, 80);
    if (bbox) { prefillCoords(bbox); drawOnCoordsMap(bbox, true); }
  }
});
cancelCoordsBtn?.addEventListener("click", () => coordsForm?.classList.add("hidden"));

// Sync when typing in fields
["input","change"].forEach(ev => {
  [coordLonW, coordLonE, coordLatS, coordLatN].forEach(el =>
    el?.addEventListener(ev, () => {
      let W = parseFloat(coordLonW.value), E = parseFloat(coordLonE.value),
          S = parseFloat(coordLatS.value), N = parseFloat(coordLatN.value);
      if (![W,E,S,N].every(Number.isFinite)) return;
      if (W > E) [W,E] = [E,W];
      if (S > N) [S,N] = [N,S];
      const b = { lonW: round(W), lonE: round(E), latS: round(S), latN: round(N) };

      // update hidden fields + preview label
      const numeric  = `${b.lonW},${b.latS} to ${b.lonE},${b.latN}`;
      const cardinal = `${fmtLon(b.lonW)}, ${fmtLat(b.latS)} to ${fmtLon(b.lonE)}, ${fmtLat(b.latN)}`;
      areaHidden.value = numeric; areaHiddenCard.value = cardinal;
      previewWrap.classList.remove("hidden"); previewLabel.textContent = cardinal;
      openPickerBtn.textContent = "Change Selected Area";

      drawOnCoordsMap(b, true);
    })
  );
});

// also wire "use" button
useCoordsBtn?.addEventListener("click", () => {
  if (coordLonW && coordLonE && coordLatS && coordLatN) {
    const W = parseFloat(coordLonW.value), E = parseFloat(coordLonE.value),
          S = parseFloat(coordLatS.value), N = parseFloat(coordLatN.value);
    if ([W,E,S,N].every(Number.isFinite)) {
      const b = { lonW: round(Math.min(W,E)), lonE: round(Math.max(W,E)),
                  latS: round(Math.min(S,N)), latN: round(Math.max(S,N)) };
      prefillCoords(b);
      drawOnCoordsMap(b, true);
    }
  }
});




</script>

</body>
</html>